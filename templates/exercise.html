{% extends "base.html" %}
{% block title %}{{ lesson.title }} - Exercise {{ index }} ¬∑ Duolingo{% endblock %}
{% block content %}
<div class="exercise-container">
  <!-- Progress Bar and Hearts -->
  <div style="position: relative; margin-bottom: 40px;">
    <div class="progress-bar">
      <div class="progress-fill" style="width: {% widthratio index total 100 %}%;"></div>
    </div>
    
    {% if profile %}
      <div class="hearts-display">
        {% for i in "12345"|slice:":"|make_list %}
          {% if forloop.counter <= profile.hearts %}
            ‚ù§Ô∏è
          {% else %}
            ü§ç
          {% endif %}
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <!-- Exercise Prompt -->
  <div class="exercise-prompt">
    {% if exercise.is_new_word and not feedback %}
      <div class="new-word-badge">
        <span>‚ú®</span>
        <span>NEW WORD</span>
      </div>
    {% endif %}

    <h3>
      {% if exercise.type == "MC" %}
        {% if exercise.choices.first.image %}
          Which one of these is "{{ exercise.prompt }}"?
        {% else %}
          Choose the correct translation
        {% endif %}
      {% elif exercise.type == "TR" %}
        Write this in English
      {% elif exercise.type == "LS" %}
        What do you hear?
      {% elif exercise.type == "SP" %}
        Say this sentence
      {% else %}
        Translate this sentence
      {% endif %}
    </h3>

    {% if exercise.type != "MC" or not exercise.choices.first.image %}
      <div class="question">
        {{ exercise.prompt }}
        {% if exercise.audio_file %}
          <button onclick="playAudio()" style="background: none; border: none; cursor: pointer; font-size: 32px; margin-left: 16px;">
            üîä
          </button>
          <audio id="exercise-audio" src="{{ exercise.audio_file.url }}"></audio>
          <script>
            function playAudio() {
              document.getElementById('exercise-audio').play();
            }
          </script>
        {% endif %}
      </div>
    {% endif %}
  </div>

  <!-- IMMEDIATE Feedback (shown after submission) -->
  {% if feedback %}
    <div class="feedback-banner" style="
      padding: 24px;
      border-radius: 16px;
      margin-bottom: 32px;
      display: flex;
      align-items: center;
      gap: 20px;
      animation: slideIn 0.3s ease-out;
      {% if feedback.is_correct %}
        background: linear-gradient(135deg, #d7ffb8 0%, #89e500 100%);
        border: 3px solid var(--duo-green);
        box-shadow: 0 8px 16px rgba(88, 204, 2, 0.3);
      {% else %}
        background: linear-gradient(135deg, #ffd2d2 0%, #ff6b6b 100%);
        border: 3px solid var(--duo-red);
        box-shadow: 0 8px 16px rgba(255, 75, 75, 0.3);
      {% endif %}
    ">
      <span style="
        font-size: 64px;
        font-weight: 900;
        line-height: 1;
        {% if feedback.is_correct %}
          color: var(--duo-green-dark);
        {% else %}
          color: #c70000;
        {% endif %}
      ">
        {% if feedback.is_correct %}‚úì{% else %}‚úó{% endif %}
      </span>
      <div style="flex: 1;">
        {% if feedback.is_correct %}
          <div style="font-size: 28px; font-weight: 900; color: var(--duo-green-dark); margin-bottom: 8px;">
            {% if feedback.first_try %}
              Perfect! üéâ
            {% else %}
              Great job! ‚≠ê
            {% endif %}
          </div>
          <div style="font-size: 18px; color: #2d5016; font-weight: 600;">
            {% if feedback.first_try %}
              You got it right on the first try! +{{ feedback.xp_earned }} XP
            {% else %}
              You corrected your answer! +{{ feedback.xp_earned }} XP
            {% endif %}
          </div>
        {% else %}
          <div style="font-size: 28px; font-weight: 900; color: #c70000; margin-bottom: 8px;">
            {% if feedback.allow_retry %}
              Not quite! üí≠
            {% else %}
              Incorrect üòî
            {% endif %}
          </div>
          <div style="font-size: 18px; color: #5c0000; font-weight: 600; margin-bottom: 8px;">
            Correct answer: <strong style="background: white; padding: 4px 12px; border-radius: 8px; color: var(--duo-green);">{{ feedback.correct_answer }}</strong>
          </div>
          {% if feedback.allow_retry %}
            <div style="font-size: 16px; color: #5c0000; font-weight: 600; padding: 12px; background: rgba(255,255,255,0.5); border-radius: 8px; margin-top: 8px;">
              üí° <strong>Try again!</strong> You have one more chance to get it right.
            </div>
          {% else %}
            <div style="font-size: 16px; color: #5c0000; font-weight: 600;">
              Study this answer and let's move on to the next question.
            </div>
          {% endif %}
        {% endif %}
      </div>
    </div>

    <style>
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  {% endif %}

  <!-- Exercise Form -->
  <form method="post">
    {% csrf_token %}

    {% if exercise.type == "MC" %}
      <!-- Multiple Choice -->
      {% if exercise.choices.first.image %}
        <!-- Visual Multiple Choice (with images) -->
        <div class="visual-choices">
          {% for choice in exercise.choices.all %}
            <label class="visual-choice-card">
              <input type="radio" name="choice" value="{{ choice.id }}" required {% if feedback %}disabled{% endif %}>
              <div class="choice-image-container">
                <img src="{{ choice.image.url }}" alt="{{ choice.text }}" style="width: 100%; height: 100%; object-fit: contain;">
              </div>
              <div class="choice-text">{{ choice.text }}</div>
              <div class="choice-number">{{ forloop.counter }}</div>
            </label>
          {% empty %}
            <p style="text-align: center; color: #777;">
              <em>No choices configured for this exercise.</em>
            </p>
          {% endfor %}
        </div>
      {% else %}
        <!-- Text Multiple Choice -->
        <div class="exercise-choices">
          {% for choice in exercise.choices.all %}
            <label class="choice-btn">
              <input type="radio" name="choice" value="{{ choice.id }}" required {% if feedback %}disabled{% endif %}>
              <div class="choice-content">
                {% if choice.text|length <= 3 %}
                  <!-- Emoji or short character -->
                  <div class="choice-image">{{ choice.text }}</div>
                {% endif %}
                
                <div class="choice-text">{{ choice.text }}</div>
                
                {% if choice.audio_file %}
                  <button type="button" onclick="playChoiceAudio{{ forloop.counter }}()" 
                          style="background: none; border: none; cursor: pointer; font-size: 24px; margin-top: 8px;">
                    üîä
                  </button>
                  <audio id="choice-audio-{{ forloop.counter }}" src="{{ choice.audio_file.url }}"></audio>
                  <script>
                    function playChoiceAudio{{ forloop.counter }}() {
                      document.getElementById('choice-audio-{{ forloop.counter }}').play();
                    }
                  </script>
                {% endif %}
                
                <div class="choice-number">{{ forloop.counter }}</div>
              </div>
            </label>
          {% empty %}
            <p style="text-align: center; color: #777; grid-column: 1/-1;">
              <em>No choices configured for this exercise.</em>
            </p>
          {% endfor %}
        </div>
      {% endif %}
    {% elif exercise.type == "LS" %}
      <!-- Listen Exercise -->
      <div style="text-align: center; margin-bottom: 32px;">
        <button type="button" onclick="playAudio()" class="btn" style="font-size: 48px; padding: 32px;">
          üîä
        </button>
        {% if exercise.audio_file %}
          <audio id="exercise-audio" src="{{ exercise.audio_file.url }}"></audio>
          <script>
            function playAudio() {
              document.getElementById('exercise-audio').play();
            }
            // Auto-play on load
            window.addEventListener('load', function() {
              document.getElementById('exercise-audio').play();
            });
          </script>
        {% endif %}
      </div>
      <input
        type="text"
        name="answer"
        class="answer-input"
        placeholder="Type what you hear..."
        required
        {% if feedback and not feedback.allow_retry %}disabled{% endif %}
        autofocus
      >
    {% else %}
      <!-- Translation Input -->
      <input
        type="text"
        name="answer"
        class="answer-input"
        placeholder="Type your translation here..."
        required
        {% if feedback and not feedback.allow_retry %}disabled{% endif %}
        autofocus
      >
    {% endif %}

    <!-- Hint -->
    {% if exercise.hint and not feedback %}
      <div style="text-align: center; margin-bottom: 24px;">
        <details style="cursor: pointer;">
          <summary style="color: var(--duo-blue); font-weight: 700; font-size: 14px; text-transform: uppercase;">
            üí° Show Hint
          </summary>
          <p style="margin-top: 12px; color: var(--duo-text-light); padding: 16px; background: #f0f9ff; border-radius: 12px;">
            {{ exercise.hint }}
          </p>
        </details>
      </div>
    {% endif %}

    <!-- Action Buttons -->
    <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px;">
      <button type="button" onclick="window.location.href='{% url 'course_detail' lesson.unit.section.course.slug %}'" 
              class="btn-gray btn">
        ‚úï Exit
      </button>

      <div style="display: flex; gap: 12px;">
        {% if not feedback %}
          <!-- Before any submission -->
          {% if exercise.type == "MC" %}
            <button type="button" onclick="skip()" class="btn-gray btn">
              Skip
            </button>
            <script>
              function skip() {
                if (confirm('Are you sure you want to skip this question?')) {
                  window.location.href = '{% url 'exercise_play' lesson.id index|add:'1' %}';
                }
              }
            </script>
          {% endif %}
          
          <button type="submit" class="btn">
            Check
          </button>
        {% elif show_continue %}
          <!-- Show continue button (correct answer OR failed second attempt) -->
          <button type="button" 
                  onclick="window.location.href='{% url 'exercise_play' lesson.id index|add:'1' %}'"
                  class="btn"
                  style="{% if feedback.is_correct %}background: var(--duo-green);{% endif %}">
            Continue ‚Üí
          </button>
        {% else %}
          <!-- Show try again button (wrong first attempt) -->
          <button type="submit" class="btn" style="background: var(--duo-orange); box-shadow: 0 4px 0 #d97706;">
            Try Again
          </button>
        {% endif %}
      </div>
    </div>
  </form>

  <!-- Progress indicator -->
  <div style="text-align: center; margin-top: 32px; color: #777; font-size: 14px; font-weight: 600;">
    Question {{ index }} of {{ total }}
    {% if attempt_count > 0 %}
      <span style="color: var(--duo-text-light);">
        {% if attempt_count == 1 %}
          ‚Ä¢ First attempt
        {% else %}
          ‚Ä¢ Second attempt
        {% endif %}
      </span>
    {% endif %}
  </div>

  <!-- Keyboard shortcuts hint -->
  <div style="text-align: center; margin-top: 16px; color: var(--duo-text-light); font-size: 12px;">
    Press <kbd style="background: var(--duo-gray); padding: 2px 8px; border-radius: 4px;">Enter</kbd> to submit
    {% if exercise.type == "MC" %}
      ‚Ä¢ Press <kbd style="background: var(--duo-gray); padding: 2px 8px; border-radius: 4px;">1</kbd>-<kbd style="background: var(--duo-gray); padding: 2px 8px; border-radius: 4px;">{{ exercise.choices.count }}</kbd> to select
    {% endif %}
  </div>
</div>

<!-- Keyboard shortcuts -->
<script>
  document.addEventListener('keydown', function(e) {
    // Enter to submit (but only if no feedback shown yet or retry allowed)
    {% if not feedback or not show_continue %}
    if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA' && !e.target.disabled) {
      const form = document.querySelector('form');
      const submitBtn = form.querySelector('button[type="submit"]');
      if (submitBtn && !submitBtn.disabled) {
        form.submit();
      }
    }
    {% endif %}
    
    // Number keys for multiple choice (only if not showing feedback)
    {% if exercise.type == "MC" and not feedback %}
    const num = parseInt(e.key);
    if (num >= 1 && num <= {{ exercise.choices.count }}) {
      const choices = document.querySelectorAll('input[name="choice"]');
      if (choices[num - 1]) {
        choices[num - 1].checked = true;
      }
    }
    {% endif %}
  });
</script>
{% endblock %}