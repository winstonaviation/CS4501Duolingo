{% extends "base.html" %}
{% block title %}{{ lesson.title }} - Exercise {{ index }} ¬∑ Multilingo{% endblock %}
{% block content %}
<div class="exercise-container">
  <!-- Progress Bar and Hearts -->
  <div style="position: relative; margin-bottom: 40px;">
    <div class="progress-bar">
      <div class="progress-fill" style="width: {% widthratio index total 100 %}%;"></div>
    </div>
    
    {% if profile %}
      <div class="hearts-display">
        {% for i in "12345"|slice:":"|make_list %}
          {% if forloop.counter <= profile.hearts %}
            ‚ù§Ô∏è
          {% else %}
            ü§ç
          {% endif %}
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <!-- Exercise Prompt -->
  <div class="exercise-prompt">
    {% if exercise.is_new_word and not feedback %}
      <div class="new-word-badge">
        <span>‚ú®</span>
        <span>NEW WORD</span>
      </div>
    {% endif %}

    <h3>
      {% if exercise.type == "MC" %}
        {% if exercise.choices.first.image %}
          Which one of these is "{{ exercise.prompt }}"?
        {% else %}
          Choose the correct translation
        {% endif %}
      {% elif exercise.type == "TR" %}
        Write this in English
      {% elif exercise.type == "LS" %}
        What do you hear?
      {% elif exercise.type == "LC" %}
        Tap what you hear
      {% elif exercise.type == "SP" %}
        Say this sentence
      {% else %}
        Translate this sentence
      {% endif %}
    </h3>

    {% if exercise.type != "MC" or not exercise.choices.first.image %}
      <div class="question">
        {% if exercise.type == "LS" or exercise.type == "LC" %}
          <!-- Audio playback for listening exercises -->
          <div style="text-align: center; margin: 32px 0;">
            <button type="button" onclick="playExerciseAudio()" class="audio-play-btn">
             <span class="audio-icon">üîä</span>
              <span class="audio-text">Play Audio</span>
           </button>
            <button type="button" onclick="playExerciseAudioSlow()" class="audio-play-btn audio-play-btn-slow" style="margin-left: 12px;">
              <span class="audio-icon">üê¢</span>
              <span class="audio-text">Slow</span>
           </button>
          </div>
          {% if exercise.audio_file %}
            <audio id="exercise-audio" src="{{ exercise.audio_file.url }}"></audio>
            <audio id="exercise-audio-slow" src="{{ exercise.audio_file.url }}"></audio>
          {% endif %}
        {% else %}
          {{ exercise.prompt }}
          {% if exercise.audio_file %}
           <button onclick="playExerciseAudio()" style="background: none; border: none; cursor: pointer; font-size: 32px; margin-left: 16px;">
             üîä
           </button>
            <audio id="exercise-audio" src="{{ exercise.audio_file.url }}"></audio>
          {% endif %}
        {% endif %}
      </div>
    {% endif %}
  </div>

  <!-- IMMEDIATE Feedback (shown after submission) -->
  {% if feedback %}
    <div class="feedback-banner" style="
      padding: 24px;
      border-radius: 16px;
      margin-bottom: 32px;
      display: flex;
      align-items: center;
      gap: 20px;
      animation: slideIn 0.3s ease-out;
      {% if feedback.is_correct %}
        background: linear-gradient(135deg, #d7ffb8 0%, #89e500 100%);
        border: 3px solid var(--duo-green);
        box-shadow: 0 8px 16px rgba(88, 204, 2, 0.3);
      {% else %}
        background: linear-gradient(135deg, #ffd2d2 0%, #ff6b6b 100%);
        border: 3px solid var(--duo-red);
        box-shadow: 0 8px 16px rgba(255, 75, 75, 0.3);
      {% endif %}
    ">
      <span style="
        font-size: 64px;
        font-weight: 900;
        line-height: 1;
        {% if feedback.is_correct %}
          color: var(--duo-green-dark);
        {% else %}
          color: #c70000;
        {% endif %}
      ">
        {% if feedback.is_correct %}‚úì{% else %}‚úó{% endif %}
      </span>
      <div style="flex: 1;">
        {% if feedback.is_correct %}
          <div style="font-size: 28px; font-weight: 900; color: var(--duo-green-dark); margin-bottom: 8px;">
            {% if feedback.first_try %}
              Perfect! üéâ
            {% else %}
              Great job! ‚≠ê
            {% endif %}
          </div>
          <div style="font-size: 18px; color: #2d5016; font-weight: 600;">
            {% if feedback.first_try %}
              You got it right on the first try! +{{ feedback.xp_earned }} XP
            {% else %}
              You corrected your answer! +{{ feedback.xp_earned }} XP
            {% endif %}
          </div>
          
          <!-- AI Feedback for Correct Answers (if using AI translation checker) -->
          {% if feedback.ai_feedback %}
            <div style="margin-top: 12px; font-size: 15px; color: #2d5016; background: rgba(255,255,255,0.5); padding: 12px; border-radius: 8px;">
              üí° {{ feedback.ai_feedback }}
            </div>
          {% endif %}
        {% else %}
          <div style="font-size: 28px; font-weight: 900; color: #c70000; margin-bottom: 8px;">
            {% if feedback.allow_retry %}
              Not quite! üí≠
            {% else %}
              Incorrect üòî
            {% endif %}
          </div>
          <div style="font-size: 18px; color: #5c0000; font-weight: 600; margin-bottom: 8px;">
            Correct answer: <strong style="background: white; padding: 4px 12px; border-radius: 8px; color: var(--duo-green);">{{ feedback.correct_answer }}</strong>
          </div>
          
          <!-- AI-Generated Mistake Explanation (Feature #4) -->
          {% if feedback.ai_explanation %}
            <div style="font-size: 15px; color: #5c0000; font-weight: 600; padding: 16px; background: rgba(255,255,255,0.7); border-radius: 12px; margin-top: 12px; border-left: 4px solid #c70000;">
              <div style="display: flex; align-items: start; gap: 12px;">
                <span style="font-size: 24px; flex-shrink: 0;">ü§ñ</span>
                <div>
                  <strong style="display: block; margin-bottom: 8px; color: #c70000;">AI Teacher Says:</strong>
                  <span style="color: #5c0000;">{{ feedback.ai_explanation }}</span>
                </div>
              </div>
            </div>
          {% endif %}
          
          {% if feedback.allow_retry %}
            <div style="font-size: 16px; color: #5c0000; font-weight: 600; padding: 12px; background: rgba(255,255,255,0.5); border-radius: 8px; margin-top: 12px;">
              üí° <strong>Try again!</strong> You have one more chance to get it right.
            </div>
          {% else %}
            <div style="font-size: 16px; color: #5c0000; font-weight: 600;">
              Study this answer and let's move on to the next question.
            </div>
          {% endif %}
        {% endif %}
      </div>
    </div>

    <style>
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  {% endif %}

  <!-- Exercise Form -->
  <form method="post" id="exerciseForm">
    {% csrf_token %}

    {% if exercise.type == "MC" %}
      <!-- Multiple Choice -->
      {% if feedback %}
        <!-- FEEDBACK STATE: Show answers with highlighting -->
        {% if exercise.choices.first.image %}
          <div class="visual-choices">
            {% for choice in exercise.choices.all %}
              <div class="visual-choice-card 
                {% if choice.is_correct %}correct-choice{% endif %}
                {% if feedback.user_choice_id == choice.id and not choice.is_correct %}wrong-choice{% endif %}"
                style="pointer-events: none;
                {% if choice.is_correct %}
                  border-color: var(--duo-green); 
                  border-width: 3px; 
                  background: #f0fdf4;
                {% elif feedback.user_choice_id == choice.id %}
                  border-color: var(--duo-red); 
                  border-width: 3px; 
                  background: #fef2f2;
                {% else %}
                  opacity: 0.5;
                {% endif %}">
                <div class="choice-image-container">
                  <img src="{{ choice.image.url }}" alt="{{ choice.text }}" style="width: 100%; height: 100%; object-fit: contain;">
                </div>
                <div class="choice-text">{{ choice.text }}</div>
                {% if choice.is_correct %}
                  <div style="position: absolute; top: 12px; right: 12px; background: var(--duo-green); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 900;">‚úì</div>
                {% elif feedback.user_choice_id == choice.id %}
                  <div style="position: absolute; top: 12px; right: 12px; background: var(--duo-red); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 900;">‚úó</div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="exercise-choices">
            {% for choice in exercise.choices.all %}
              <div class="choice-btn 
                {% if choice.is_correct %}correct-choice{% endif %}
                {% if feedback.user_choice_id == choice.id and not choice.is_correct %}wrong-choice{% endif %}"
                style="pointer-events: none;
                {% if choice.is_correct %}
                  border-color: var(--duo-green); 
                  border-width: 3px; 
                  background: #f0fdf4;
                {% elif feedback.user_choice_id == choice.id %}
                  border-color: var(--duo-red); 
                  border-width: 3px; 
                  background: #fef2f2;
                {% else %}
                  opacity: 0.5;
                {% endif %}">
                <div class="choice-content">
                  {% if choice.text|length <= 3 %}
                    <div class="choice-image">{{ choice.text }}</div>
                  {% endif %}
                  <div class="choice-text">{{ choice.text }}</div>
                  {% if choice.is_correct %}
                    <div style="margin-left: auto; color: var(--duo-green); font-size: 24px; font-weight: 900;">‚úì</div>
                  {% elif feedback.user_choice_id == choice.id %}
                    <div style="margin-left: auto; color: var(--duo-red); font-size: 24px; font-weight: 900;">‚úó</div>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% else %}
        <!-- NORMAL STATE: Allow selection -->
        {% if exercise.choices.first.image %}
          <!-- Visual Multiple Choice (with images) -->
          <div class="visual-choices">
            {% for choice in exercise.choices.all %}
              <label class="visual-choice-card">
                <input type="radio" name="choice" value="{{ choice.id }}" required>
                <div class="choice-image-container">
                  <img src="{{ choice.image.url }}" alt="{{ choice.text }}" style="width: 100%; height: 100%; object-fit: contain;">
                </div>
                <div class="choice-text">{{ choice.text }}</div>
                <div class="choice-number">{{ forloop.counter }}</div>
              </label>
            {% empty %}
              <p style="text-align: center; color: #777;">
                <em>No choices configured for this exercise.</em>
              </p>
            {% endfor %}
          </div>
        {% else %}
          <!-- Text Multiple Choice -->
          <div class="exercise-choices">
            {% for choice in exercise.choices.all %}
              <label class="choice-btn">
                <input type="radio" name="choice" value="{{ choice.id }}" required>
                <div class="choice-content">
                  {% if choice.text|length <= 3 %}
                    <div class="choice-image">{{ choice.text }}</div>
                  {% endif %}
                  
                  <div class="choice-text">{{ choice.text }}</div>
                  
                  {% if choice.audio_file %}
                    <button type="button" onclick="playChoiceAudio{{ forloop.counter }}()" 
                            style="background: none; border: none; cursor: pointer; font-size: 24px; margin-top: 8px;">
                      üîä
                    </button>
                    <audio id="choice-audio-{{ forloop.counter }}" src="{{ choice.audio_file.url }}"></audio>
                    <script>
                      function playChoiceAudio{{ forloop.counter }}() {
                        document.getElementById('choice-audio-{{ forloop.counter }}').play();
                      }
                    </script>
                  {% endif %}
                  
                  <div class="choice-number">{{ forloop.counter }}</div>
                </div>
              </label>
            {% empty %}
              <p style="text-align: center; color: #777; grid-column: 1/-1;">
                <em>No choices configured for this exercise.</em>
              </p>
            {% endfor %}
          </div>
        {% endif %}
      {% endif %}
    {% elif exercise.type == "LS" or exercise.type == "LC" %}
      <!-- Listen & Select or Listen & Construct Exercise -->
      {% if exercise.type == "LC" %}
        <!-- Word Bank for Listening Construction -->
        <div class="word-bank-container">
          <div id="constructed-sentence" class="constructed-sentence">
            <!-- Words will be added here by clicking buttons -->
          </div>
          
          <div class="word-bank">
            {% for word in exercise.word_bank %}
              <button type="button" class="word-bank-btn" onclick="addWord(this, '{{ word }}')">
                {{ word }}
              </button>
            {% endfor %}
          </div>
          
          <input type="hidden" name="answer" id="constructed-answer" value="">
        </div>
      {% else %}
        <!-- Regular text input for listening -->
        {% if feedback and feedback.is_correct %}
          <input
            type="text"
            class="answer-input"
            value="{{ exercise.answer_text }}"
            disabled
            style="background: #f0fdf4; border-color: var(--duo-green); color: var(--duo-green-dark);"
          >
        {% elif feedback and not feedback.allow_retry %}
          <input
            type="text"
            class="answer-input"
            value="{{ exercise.answer_text }}"
            disabled
            style="background: #f0fdf4; border-color: var(--duo-green); color: var(--duo-green-dark);"
          >
        {% else %}
          <input
            type="text"
            name="answer"
            class="answer-input"
            placeholder="Type what you hear..."
            required
            autofocus
          >
        {% endif %}
      {% endif %}
    {% else %}
      <!-- Translation Input (TR type) -->
      {% if feedback and feedback.is_correct %}
        <input
          type="text"
          class="answer-input"
          value="{{ exercise.answer_text }}"
          disabled
          style="background: #f0fdf4; border-color: var(--duo-green); color: var(--duo-green-dark);"
        >
      {% elif feedback and not feedback.allow_retry %}
        <input
          type="text"
          class="answer-input"
          value="{{ exercise.answer_text }}"
          disabled
          style="background: #f0fdf4; border-color: var(--duo-green); color: var(--duo-green-dark);"
        >
      {% else %}
        <input
          type="text"
          name="answer"
          id="answer-input"
          class="answer-input"
          placeholder="Type your translation here..."
          required
          autofocus
        >
        
        <!-- Accented Characters Keyboard (for Spanish, French, etc.) -->
        {% if profile.learning_language == 'es' or profile.learning_language == 'fr' %}
          <div class="accent-keyboard">
            {% if profile.learning_language == 'es' %}
              <button type="button" class="accent-btn" onclick="insertChar('√°')">√°</button>
              <button type="button" class="accent-btn" onclick="insertChar('√©')">√©</button>
              <button type="button" class="accent-btn" onclick="insertChar('√≠')">√≠</button>
              <button type="button" class="accent-btn" onclick="insertChar('√≥')">√≥</button>
              <button type="button" class="accent-btn" onclick="insertChar('√∫')">√∫</button>
              <button type="button" class="accent-btn" onclick="insertChar('√±')">√±</button>
              <button type="button" class="accent-btn" onclick="insertChar('¬ø')">¬ø</button>
              <button type="button" class="accent-btn" onclick="insertChar('¬°')">¬°</button>
            {% elif profile.learning_language == 'fr' %}
              <button type="button" class="accent-btn" onclick="insertChar('√†')">√†</button>
              <button type="button" class="accent-btn" onclick="insertChar('√¢')">√¢</button>
              <button type="button" class="accent-btn" onclick="insertChar('√©')">√©</button>
              <button type="button" class="accent-btn" onclick="insertChar('√®')">√®</button>
              <button type="button" class="accent-btn" onclick="insertChar('√™')">√™</button>
              <button type="button" class="accent-btn" onclick="insertChar('√´')">√´</button>
              <button type="button" class="accent-btn" onclick="insertChar('√Æ')">√Æ</button>
              <button type="button" class="accent-btn" onclick="insertChar('√Ø')">√Ø</button>
              <button type="button" class="accent-btn" onclick="insertChar('√¥')">√¥</button>
              <button type="button" class="accent-btn" onclick="insertChar('√π')">√π</button>
              <button type="button" class="accent-btn" onclick="insertChar('√ª')">√ª</button>
              <button type="button" class="accent-btn" onclick="insertChar('√ß')">√ß</button>
            {% endif %}
          </div>
        {% endif %}
      {% endif %}
    {% endif %}

    <!-- AI-Powered Smart Hint Section (Feature #2) -->
    {% if not feedback or feedback.allow_retry %}
      <div style="text-align: center; margin: 24px 0;">
        <!-- AI Hint Container (hidden until loaded) -->
        <div id="hint-container" style="display: none; margin-bottom: 16px; padding: 16px; background: #f0f9ff; border-radius: 12px; border-left: 4px solid var(--duo-blue); text-align: left;">
          <div style="display: flex; align-items: start; gap: 12px;">
            <span style="font-size: 24px; flex-shrink: 0;">üí°</span>
            <div style="flex: 1;">
              <strong style="color: var(--duo-blue); display: block; margin-bottom: 8px;">AI Smart Hint:</strong>
              <p id="hint-text" style="color: var(--duo-text); margin: 0; line-height: 1.6;"></p>
            </div>
          </div>
        </div>
        
        <!-- Get AI Hint Button -->
        <button type="button" id="hint-button" onclick="getAIHint()" class="btn-gray btn" style="margin-bottom: 8px;">
          <span id="hint-button-text">üí° Get Smart Hint</span>
          <span id="hint-loading" style="display: none;">
            <span class="spinner">‚è≥</span> Generating hint...
          </span>
        </button>
        
        <!-- Static hint fallback (if available) -->
        {% if exercise.hint %}
          <details style="cursor: pointer; margin-top: 8px;">
            <summary style="color: var(--duo-text-light); font-weight: 700; font-size: 13px; text-transform: uppercase; padding: 8px;">
              üìù Quick Tip
            </summary>
            <p style="margin-top: 12px; color: var(--duo-text-light); padding: 12px; background: #f7f7f7; border-radius: 8px; font-size: 14px; line-height: 1.5;">
              {{ exercise.hint }}
            </p>
          </details>
        {% endif %}
      </div>
      
      <script>
        let hintRequested = false;
        
        function getAIHint() {
          if (hintRequested) return;
          hintRequested = true;
          
          const button = document.getElementById('hint-button');
          const buttonText = document.getElementById('hint-button-text');
          const loading = document.getElementById('hint-loading');
          const container = document.getElementById('hint-container');
          const hintText = document.getElementById('hint-text');
          
          // Show loading state
          buttonText.style.display = 'none';
          loading.style.display = 'inline-flex';
          button.disabled = true;
          
          // Fetch AI hint via AJAX
          fetch('/ajax/hint/{{ exercise.id }}/')
            .then(response => {
              if (!response.ok) {
                throw new Error('Network response was not ok');
              }
              return response.json();
            })
            .then(data => {
              hintText.textContent = data.hint;
              container.style.display = 'block';
              button.style.display = 'none';
            })
            .catch(error => {
              console.error('Error fetching hint:', error);
              hintText.textContent = 'Sorry, couldn\'t generate a hint right now. Try the quick tip below!';
              container.style.display = 'block';
              button.style.display = 'none';
            });
        }
      </script>
    {% endif %}

    <!-- Action Buttons -->
    <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px; margin-top: 32px;">
      <button type="button" onclick="window.location.href='{% url 'course_detail' lesson.unit.section.course.slug %}'" 
              class="btn-gray btn">
        ‚úï Exit
      </button>

      <div style="display: flex; gap: 12px;">
        {% if not feedback %}
          {% if exercise.type == "MC" %}
            <button type="button" onclick="skip()" class="btn-gray btn">
              Skip
            </button>
            <script>
              function skip() {
                if (confirm('Are you sure you want to skip this question?')) {
                  window.location.href = '{% url 'exercise_play' lesson.id index|add:'1' %}';
                }
              }
            </script>
          {% endif %}
          
          <button type="submit" class="btn" id="submit-btn">
            <span class="submit-text">Check</span>
            <span class="submit-loading" style="display: none;">
              <span class="spinner">‚è≥</span> Checking...
            </span>
          </button>
        {% elif show_continue %}
          <button type="button" 
                  onclick="window.location.href='{% url 'exercise_play' lesson.id index|add:'1' %}'"
                  class="btn"
                  style="{% if feedback.is_correct %}background: var(--duo-green);{% endif %}">
            Continue ‚Üí
          </button>
        {% else %}
          <button type="submit" class="btn" style="background: var(--duo-orange); box-shadow: 0 4px 0 #d97706;">
            Try Again
          </button>
        {% endif %}
      </div>
    </div>
  </form>

  <!-- Progress indicator -->
  <div style="text-align: center; margin-top: 32px; color: #777; font-size: 14px; font-weight: 600;">
    Question {{ index }} of {{ total }}
    {% if attempt_count > 0 %}
      <span style="color: var(--duo-text-light);">
        {% if attempt_count == 1 %}
          ‚Ä¢ First attempt
        {% else %}
          ‚Ä¢ Second attempt
        {% endif %}
      </span>
    {% endif %}
  </div>

  <!-- Keyboard shortcuts hint -->
  <div style="text-align: center; margin-top: 16px; color: var(--duo-text-light); font-size: 12px;">
    Press <kbd style="background: var(--duo-gray); padding: 2px 8px; border-radius: 4px; font-family: monospace;">Enter</kbd> to submit
    {% if exercise.type == "MC" and not feedback %}
      ‚Ä¢ Press <kbd style="background: var(--duo-gray); padding: 2px 8px; border-radius: 4px; font-family: monospace;">1</kbd>-<kbd style="background: var(--duo-gray); padding: 2px 8px; border-radius: 4px; font-family: monospace;">{{ exercise.choices.count }}</kbd> to select
    {% endif %}
  </div>
</div>

<!-- Audio Functions -->
<script>
  function playExerciseAudio() {
    const audio = document.getElementById('exercise-audio');
    if (audio) {
      audio.playbackRate = 1.0;
      audio.play();
    }
  }
  
  function playExerciseAudioSlow() {
    const audio = document.getElementById('exercise-audio-slow');
    if (audio) {
      audio.playbackRate = 0.6; // Slower playback
      audio.play();
    }
  }
  
  // Auto-play audio for listening exercises
  {% if exercise.type == "LS" or exercise.type == "LC" %}
  window.addEventListener('load', function() {
    setTimeout(function() {
      playExerciseAudio();
    }, 500);
  });
  {% endif %}
</script>

<!-- Accented Character Insertion -->
<script>
  function insertChar(char) {
    const input = document.getElementById('answer-input');
    if (input) {
      const start = input.selectionStart;
      const end = input.selectionEnd;
      const text = input.value;
      input.value = text.substring(0, start) + char + text.substring(end);
      input.focus();
      input.setSelectionRange(start + 1, start + 1);
    }
  }
</script>

<!-- Show loading state on form submit -->
<script>
  document.getElementById('exerciseForm').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('submit-btn');
    if (submitBtn) {
      const submitText = submitBtn.querySelector('.submit-text');
      const submitLoading = submitBtn.querySelector('.submit-loading');
      if (submitText && submitLoading) {
        submitText.style.display = 'none';
        submitLoading.style.display = 'inline-flex';
        submitBtn.disabled = true;
      }
    }
  });
</script>

<!-- Word Bank Construction (for LC type exercises) -->
{% if exercise.type == "LC" %}
<script>
  function addWord(button, word) {
    // Get constructed sentence container
    const constructedSentence = document.getElementById('constructed-sentence');
    
    // Create word element
    const wordElement = document.createElement('span');
    wordElement.className = 'constructed-word';
    wordElement.textContent = word;
    wordElement.onclick = function() {
      removeWord(wordElement, button);
    };
    
    // Store reference to original button
    wordElement.dataset.buttonId = Array.from(button.parentNode.children).indexOf(button);
    
    // Add to constructed sentence
    constructedSentence.appendChild(wordElement);
    
    // Mark button as used
    button.classList.add('used');
    
    // Update hidden input
    updateConstructedAnswer();
  }
  
  function removeWord(wordElement, originalButton) {
    // Remove from constructed sentence
    wordElement.remove();
    
    // Re-enable button in word bank
    originalButton.classList.remove('used');
    
    // Update hidden input
    updateConstructedAnswer();
  }
  
  function updateConstructedAnswer() {
    const constructedSentence = document.getElementById('constructed-sentence');
    const words = Array.from(constructedSentence.querySelectorAll('.constructed-word'))
      .map(el => el.textContent);
    document.getElementById('constructed-answer').value = words.join(' ');
  }
</script>
{% endif %}

<!-- Keyboard shortcuts -->
<script>
  document.addEventListener('keydown', function(e) {
    {% if feedback %}
      {% if feedback.is_correct or not feedback.allow_retry %}
        // Enter to continue (correct answer or out of retries)
        if (e.key === 'Enter') {
          e.preventDefault();
          window.location.href = '{% url 'exercise_play' lesson.id index|add:'1' %}';
        }
      {% else %}
        // Enter to submit retry (wrong first attempt)
        if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA' && !e.target.disabled) {
          e.preventDefault();
          const form = document.querySelector('#exerciseForm');
          const submitBtn = form.querySelector('button[type="submit"]');
          if (submitBtn && !submitBtn.disabled) {
            form.submit();
          }
        }
      {% endif %}
    {% else %}
      // Enter to submit initial answer (no feedback yet)
      if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA' && !e.target.disabled) {
        e.preventDefault();
        const form = document.querySelector('#exerciseForm');
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn && !submitBtn.disabled) {
          form.submit();
        }
      }
    {% endif %}
    
    // Number keys for multiple choice (only if not showing feedback)
    {% if exercise.type == "MC" and not feedback %}
    const num = parseInt(e.key);
    if (num >= 1 && num <= {{ exercise.choices.count }}) {
      const choices = document.querySelectorAll('input[name="choice"]');
      if (choices[num - 1]) {
        choices[num - 1].checked = true;
      }
    }
    {% endif %}
  });
</script>

<style>
  /* Spinner Animation */
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .spinner {
    display: inline-block;
    animation: spin 1s linear infinite;
  }

  /* Audio Button Styles */
  .audio-play-btn {
    display: inline-flex;
    align-items: center;
    gap: 12px;
    padding: 20px 32px;
    background: linear-gradient(135deg, #1cb0f6 0%, #0084c7 100%);
    border: none;
    border-radius: 16px;
    color: white;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 4px 0 #0084c7;
  }

  .audio-play-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 0 #0084c7;
  }

  .audio-play-btn:active {
    transform: translateY(2px);
    box-shadow: 0 2px 0 #0084c7;
  }

  .audio-play-btn-slow {
    background: linear-gradient(135deg, #ffc800 0%, #ff9600 100%);
    box-shadow: 0 4px 0 #cc7a00;
  }

  .audio-play-btn-slow:hover {
    box-shadow: 0 6px 0 #cc7a00;
  }

  .audio-play-btn-slow:active {
    box-shadow: 0 2px 0 #cc7a00;
  }

  /* Word Bank Styles */
  .word-bank-container {
    margin-bottom: 32px;
  }

  .constructed-sentence {
    min-height: 80px;
    padding: 20px;
    background: white;
    border: 3px dashed var(--duo-gray);
    border-radius: 16px;
    margin-bottom: 24px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    justify-content: center;
  }

  .word-bank {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: center;
    padding: 24px;
    background: #f7f7f7;
    border-radius: 16px;
  }

  .word-bank-btn {
    padding: 16px 24px;
    background: white;
    border: 2px solid var(--duo-gray);
    border-radius: 12px;
    font-size: 18px;
    font-weight: 700;
    color: var(--duo-text);
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 4px 0 #ccc;
  }

  .word-bank-btn:hover:not(.used) {
    transform: translateY(-2px);
    box-shadow: 0 6px 0 #ccc;
  }

  .word-bank-btn:active:not(.used) {
    transform: translateY(2px);
    box-shadow: 0 2px 0 #ccc;
  }

  .word-bank-btn.used {
    opacity: 0.3;
    pointer-events: none;
  }

  .constructed-word {
    padding: 16px 24px;
    background: var(--duo-blue);
    color: white;
    border-radius: 12px;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 4px 0 #0084c7;
    transition: all 0.2s;
  }

  .constructed-word:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 0 #0084c7;
  }

  .constructed-word:active {
    transform: translateY(2px);
    box-shadow: 0 2px 0 #0084c7;
  }

  /* Wrong choice highlighting */
  .wrong-choice {
    animation: shake 0.5s;
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
  }

  /* Accented Characters Keyboard */
  .accent-keyboard {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-top: 16px;
    padding: 16px;
    background: #f7f7f7;
    border-radius: 12px;
    flex-wrap: wrap;
  }

  .accent-btn {
    min-width: 48px;
    height: 48px;
    padding: 8px 12px;
    background: white;
    border: 2px solid var(--duo-gray);
    border-radius: 8px;
    font-size: 20px;
    font-weight: 700;
    color: var(--duo-text);
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 2px 0 #ccc;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .accent-btn:hover {
    background: #f0f9ff;
    border-color: var(--duo-blue);
    transform: translateY(-2px);
    box-shadow: 0 4px 0 #ccc;
  }

  .accent-btn:active {
    transform: translateY(0);
    box-shadow: 0 1px 0 #ccc;
  }
</style>
{% endblock %}